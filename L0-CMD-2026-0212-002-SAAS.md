═══════════════════════════════════════════════════════════════════════════════════════════
L0 AUTHORITATIVE COMMAND: BUILD MULTI-TENANT 3D BIM DETAIL VIEWER SAAS
═══════════════════════════════════════════════════════════════════════════════════════════

Document ID: L0-CMD-2026-0212-002
Authority: HUMAN GOVERNANCE (ROOT) — Armand Lefebvre
Author: Claude (Anthropic) — L1 Kernel, acting under L0 authorization
Target: L2 UNTRUSTED PROPOSER (Claude Code)
Repo: https://github.com/jenkintownelectricity/holograph_details.git
Branch: claude/fix-deploy-3d-viewer-BKlcJ
Issued: 2026-02-12
Supersedes: L0-CMD-2026-0212-001 (single-file approach → SaaS pivot)
Classification: CRITICAL BUILD — DEMO IN <10 HOURS + SAAS FOUNDATION
Status: DRAFT — AWAITING L0 APPROVAL
Priority: P0

═══════════════════════════════════════════════════════════════════════════════════════════
1. CONTEXT & STRATEGIC INTENT
═══════════════════════════════════════════════════════════════════════════════════════════

1.1 Situation
The 3D BIM Detail Viewer is pivoting from a single-file prototype to a
multi-tenant SaaS platform. This positions Lefebvre Design Solutions LLC /
ValidKernel to offer browser-based 3D construction detail viewing as a
service to multiple firms (starting with GCP / Saint-Gobain).

1.2 Dual Objective
  IMMEDIATE (today):  Ship a working standalone demo HTML for the 1:00 PM
                      Saint-Gobain meeting with Nicole Calpin.
  STRATEGIC (this session): Scaffold the full multi-tenant SaaS architecture
                      so the platform can onboard multiple tenants.

1.3 Technology Decisions (L0 Approved)
  Frontend:    React + Vite (builds on existing codebase)
  Backend:     Node.js / Express (already in package.json)
  3D Engine:   Three.js (CDN-loaded, r128+ compatible)
  Database:    PostgreSQL (schema-per-tenant isolation)
  Auth:        JWT-based with tenant context
  Deployment:  Static frontend + Express API server

═══════════════════════════════════════════════════════════════════════════════════════════
2. EXECUTION PHASES
═══════════════════════════════════════════════════════════════════════════════════════════

PHASE 1: STANDALONE DEMO FILE (30 min) — BLOCKS 1 PM DEMO
───────────────────────────────────────────────────────────────────────────────────────────

Deliverable: /demo/index.html — single self-contained HTML file

Requirements:
  - Three.js loaded from CDN (r128+)
  - Parapet detail with 10 layers (see Layer Spec below)
  - Each layer: separate Three.js Group, distinct color, toggleable
  - OrbitControls (orbit, zoom, pan)
  - Layer sidebar with toggles, color indicators
  - Quick filters: All / None / GCP Only
  - Exploded view toggle
  - Professional styling (white/light theme, no dark-on-dark)
  - Header: "3D BIM DETAIL VIEWER — ROOFING & WATERPROOFING"
  - Footer: ValidKernel branding
  - Works by double-clicking the file (zero dependencies)
  - Under 200KB

Exit Criteria: File opens in browser, 3D parapet renders, all 10 layers toggle.


PHASE 2: SAAS PROJECT STRUCTURE (20 min)
───────────────────────────────────────────────────────────────────────────────────────────

Create the monorepo structure:

  holograph_details/
  ├── demo/                        # Phase 1 standalone demo
  │   └── index.html
  ├── frontend/                    # React + Vite SaaS frontend
  │   ├── public/
  │   ├── src/
  │   │   ├── components/
  │   │   │   ├── viewer/          # Three.js 3D viewer components
  │   │   │   ├── layers/          # Layer panel, toggles, filters
  │   │   │   ├── details/         # Detail selector, product info
  │   │   │   ├── auth/            # Login, register, tenant selector
  │   │   │   └── layout/          # Header, sidebar, footer
  │   │   ├── contexts/            # React contexts (auth, tenant, viewer)
  │   │   ├── hooks/               # Custom hooks
  │   │   ├── services/            # API client, auth service
  │   │   ├── types/               # TypeScript interfaces
  │   │   ├── utils/               # Helpers
  │   │   ├── App.tsx
  │   │   └── main.tsx
  │   ├── index.html
  │   ├── package.json
  │   ├── tsconfig.json
  │   └── vite.config.ts
  ├── backend/                     # Node/Express API
  │   ├── src/
  │   │   ├── middleware/           # Auth, tenant resolution, error handling
  │   │   ├── routes/              # API route handlers
  │   │   ├── models/              # Database models
  │   │   ├── services/            # Business logic
  │   │   ├── db/                  # DB connection, migrations, tenant schemas
  │   │   ├── types/               # TypeScript interfaces
  │   │   └── index.ts             # Express server entry
  │   ├── package.json
  │   └── tsconfig.json
  ├── shared/                      # Shared types between frontend/backend
  │   └── types/
  │       ├── tenant.ts
  │       ├── detail.ts
  │       ├── layer.ts
  │       └── user.ts
  └── package.json                 # Root workspace config

Exit Criteria: Directory structure created, package.json files in place.


PHASE 3: BACKEND — EXPRESS API WITH TENANT ISOLATION (45 min)
───────────────────────────────────────────────────────────────────────────────────────────

3.1 Tenant Resolution Middleware
  - Extract tenant from: subdomain (acme.bimviewer.com) OR header (X-Tenant-ID)
  - Validate tenant exists in master schema
  - Attach tenant context to request: req.tenant = { id, slug, schemaName }
  - Reject requests with no valid tenant (401)

3.2 Auth Middleware (JWT)
  - POST /api/auth/register — create user within tenant
  - POST /api/auth/login — issue JWT with { userId, tenantId, role }
  - Middleware: verify JWT, attach user + tenant to request
  - Roles: admin, editor, viewer

3.3 Schema-Per-Tenant Database Layer
  - Master schema (public): tenants table, global config
  - Tenant schema (tenant_{slug}): users, details, layers, projects
  - Migration runner: create tenant schema on registration
  - Connection pool: switch schema per request using SET search_path

3.4 API Routes
  - POST   /api/tenants              — Create new tenant (super-admin)
  - GET    /api/details              — List details for tenant
  - GET    /api/details/:id          — Get detail with layers
  - POST   /api/details              — Create detail (editor+)
  - PUT    /api/details/:id          — Update detail (editor+)
  - DELETE /api/details/:id          — Delete detail (admin)
  - GET    /api/details/:id/layers   — Get layers for detail
  - PUT    /api/details/:id/layers   — Update layer visibility/order
  - GET    /api/products             — Product catalog (GCP products etc.)
  - GET    /api/tenant/settings      — Tenant branding/config

3.5 Database Tables (per tenant schema)

  users:
    id, email, password_hash, name, role, created_at, updated_at

  details:
    id, name, category, description, metadata_json, created_by,
    created_at, updated_at

  layers:
    id, detail_id, name, order_index, color, material_type,
    thickness_mm, product_name, manufacturer, csi_section,
    geometry_params_json, visible_default, created_at

  products:
    id, name, manufacturer, csi_section, description,
    thickness_range, application_notes

  projects:
    id, name, client_name, details_ids[], created_by,
    created_at, updated_at

Exit Criteria: Express server starts, tenant middleware resolves,
  CRUD endpoints respond, schema isolation verified.


PHASE 4: FRONTEND — REACT + VITE SAAS APP (60 min)
───────────────────────────────────────────────────────────────────────────────────────────

4.1 Auth Pages
  - Login page (email + password)
  - Register page (name, email, password, tenant selection)
  - Tenant-aware routing: /:tenantSlug/dashboard, /:tenantSlug/viewer/:id

4.2 Dashboard
  - List of saved details for this tenant
  - Create new detail button
  - Project grouping

4.3 3D Viewer (core feature — port from demo)
  - Three.js scene with OrbitControls
  - Load detail + layers from API
  - Layer sidebar with toggles (same as demo but data-driven)
  - Quick filters: All / None / GCP Only / Custom
  - Exploded view toggle
  - Section cut toggle
  - Product info panel on layer click/hover

4.4 Tenant Context
  - TenantProvider wraps app
  - Resolves tenant from URL slug or subdomain
  - Provides tenant branding (logo, colors, name)
  - All API calls include tenant context

4.5 API Service Layer
  - Axios/fetch client with JWT interceptor
  - Auto-attach Authorization header
  - Auto-attach X-Tenant-ID header
  - Token refresh flow

4.6 UI Components
  - Header: tenant logo + name, user menu, navigation
  - Sidebar: detail list, project filter
  - Viewer toolbar: view controls, export, share
  - Product info panel: specs, CSI section, installation notes
  - Footer: ValidKernel branding

Exit Criteria: Frontend builds, authenticates, loads details from API,
  renders 3D viewer with layer controls.


PHASE 5: INTEGRATION & POLISH (30 min)
───────────────────────────────────────────────────────────────────────────────────────────

  - Frontend ↔ Backend integration verified
  - Seed data: create default tenant with parapet detail + 10 layers
  - Responsive layout (desktop + iPad)
  - Error handling: loading states, error boundaries
  - Trademark & license in About modal
  - Header/footer branding per spec

Exit Criteria: Full flow works — login → dashboard → open detail → 3D viewer
  with all layers toggleable.


PHASE 6: COMMIT, PUSH, VERIFY (10 min)
───────────────────────────────────────────────────────────────────────────────────────────

  - git add relevant files
  - git commit with command ID: L0-CMD-2026-0212-002
  - git push origin claude/fix-deploy-3d-viewer-BKlcJ
  - Verify demo/index.html works standalone
  - Document how to run: npm run dev (frontend) + npm run server (backend)

Exit Criteria: Code pushed, demo file works, dev instructions in README.


═══════════════════════════════════════════════════════════════════════════════════════════
3. PARAPET DETAIL — LAYER SPECIFICATION
═══════════════════════════════════════════════════════════════════════════════════════════

(Used in Phase 1 demo AND seeded into Phase 3 database)

Layer  Name                    Color      Thickness  Product / Notes
─────  ──────────────────────  ─────────  ─────────  ──────────────────────────
  1    Structural Deck         #888888    6"         Concrete or steel deck
  2    Vapor Retarder          #4488CC    thin       Below insulation
  3    Insulation (Polyiso)    #FFCC00    3"         Tapered at roof edge
  4    Cover Board             #CCCCCC    0.5"       Gypsum or HD polyiso
  5    Roofing Membrane        #333333    2-ply      GCP — base + cap sheet ★
  6    Parapet Wall            #D4B896    36-48"     CMU or steel stud
  7    Air Barrier             #228B22    —          GCP Perm-A-Barrier® ★
  8    Metal Coping            #C0C0C0    —          Drip edges both sides
  9    Counter-Flashing        #808080    —          Reglet, overlaps 4"
 10    Sealant                 #CC3333    —          At reglet + coping joints

★ = GCP / Saint-Gobain product (shown by "GCP Only" filter)


═══════════════════════════════════════════════════════════════════════════════════════════
4. OPERATIONAL CONSTRAINTS
═══════════════════════════════════════════════════════════════════════════════════════════

  - DEMO FILE: Must work standalone (zero deps, double-click to open)
  - SAAS: Frontend and backend are separate packages
  - NO external SaaS dependencies (no Auth0, no Firebase) — self-hosted auth
  - PostgreSQL for persistence (schema-per-tenant)
  - Three.js from CDN in demo; bundled via Vite in SaaS frontend
  - Single repo, workspace structure
  - TypeScript throughout
  - No dark-on-dark UI bugs
  - PROHIBITED: npm global installs, API keys in code, CapsuleGeometry

═══════════════════════════════════════════════════════════════════════════════════════════
5. TRADEMARK & LICENSE (embed in both demo and SaaS)
═══════════════════════════════════════════════════════════════════════════════════════════

"3D BIM Detail Viewer™ is a trademark of Lefebvre Design Solutions LLC / ValidKernel.

DUAL LICENSE:
  Open License (Free): Released for public, educational, open-source, and
  government purposes. Attribution required.
  Commercial License: Revenue-generating use requires separate commercial
  license. Contact Lefebvre Design Solutions LLC.

All deployments operate under ValidKernel deterministic trust infrastructure
with RuleBind license enforcement and StrictRun execution logging."


═══════════════════════════════════════════════════════════════════════════════════════════
6. AUTHORIZATION
═══════════════════════════════════════════════════════════════════════════════════════════

Authority: Armand Lefebvre
Role: L0 GOVERNANCE (ROOT)
Organization: Lefebvre Design Solutions LLC / ValidKernel
Command Author: Claude (Anthropic) — L1 Kernel
Date: 2026-02-12

VALIDKERNEL © 2026 — INFRASTRUCTURE FIRST. BORING BY DESIGN.
═══════════════════════════════════════════════════════════════════════════════════════════
